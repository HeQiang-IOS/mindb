<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tracks</title>
  <style>
    body {
      padding: 0;
      margin: 0;
      overflow: hidden;
    }
    #view {
      padding: .7em;

      font-size: 1.1em;

      position: absolute;
      bottom: 1em;
      right: 1em;
    }
    #board {
      width: 100%;
      height: 100%;
    }
    #point {
      width: 7px;
      height: 7px;
      border-radius: 7px;
      background: #333;
      position: absolute;
      top: 56%;
      left: 50%;
    }
    #point.click {
      background: red;
    }
    h3 {
      text-align: center;
      display: block;
      width: 21em;
      height: 1em;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      margin: auto;
      position: absolute;
    }
  </style>
</head>
<body>
  <span id="point"></span>
  <h3>Moving and click.<br />Press any key to mock the mouse moving.</h3>
  <div id="output"></div>
  <script src="min.all.js"></script>
  <script src="http://cdn.staticfile.org/underscore.js/1.6.0/underscore-min.js"></script>
  <script src="http://cdn.staticfile.org/jquery/2.1.1-rc2/jquery.min.js"></script>
  <script>
    (function() {
      var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
      window.requestAnimationFrame = requestAnimationFrame;

      var $log = $('#output');

      min.store = new min.memStore();
      min.multi()
        .set('tracks:move', [])
        .set('tracks:click', [])
        .exec(function() {});

      var $point = $('#point');

      var trackMoving = function() {
        var pos = {
          x: 0,
          y: 0,
          changed: false
        };

        window.addEventListener('mousemove', function(evt) {
          if (Math.abs(evt.clientX - pos.x) + Math.abs(evt.clientY - pos.y) == 0)
            return pos.changed = false;

          pos.x = evt.clientX;
          pos.y = evt.clientY;
          pos.changed = true;
        });
        window.addEventListener('moseenter', function(evt) {
          console.log(evt);
        });

        return setInterval(function() {
          if (pos.changed) {
            min.emit('track:move', pos, Date.now());
            pos.changed = false;
          }
        }, 500);
      };

      var timer = trackMoving();

      window.addEventListener('click', function(evt) {
        clearInterval(timer);
        min.emit('track:click', {
          x: evt.clientX,
          y: evt.clientY
        }, Date.now());
        timer = trackMoving();
      });

      min
        .on('track:move', function(pos, time) {
          min.sadd('tracks:move', {
            time: time, 
            x: pos.x,
            y: pos.y
          });
        })
        .on('track:click', function(pos, time) {
          min.sadd('tracks:click', {
            time: time, 
            x: pos.x,
            y: pos.y
          });
        });

      var movements = [];

      min.on('sadd', function(key) {
        min.smembers(key).then(function(members) {
          var pos = members[members.length - 1];

          $log.append()

          console.log(key.substr(7) + ' (%d, %d)', pos.x, pos.y);

          movements.push(pos);
        });
      });

      var STEPS = 200;

      function caculatePattern(per, points, ary) {
        var arr = [];
        var node = points.reduce(function(prev, curr, index) {
          var __prev = points[index - 1];

          var point = {
            x: __prev.x + (curr.x - __prev.x) * per,
            y: __prev.y + (curr.y - __prev.y) * per
          };

          arr.push(point);
          return point;
        });

        if (arr.length > 1) {
          caculatePattern(per, arr, ary);
        } else {
          ary.push(node);
        }

        return ary;
      }

      function caculatePath(points) {
        var path = [];

        for (var i = 0; i < STEPS; i++) {
          path = path.concat(caculatePattern(i / STEPS, points, []));
        }

        return path;
      }

      function mockPath(callback) {
        min.multi()
          .smembers('tracks:move')
          .smembers('tracks:click')
          .exec(function(err, results) {
            if (err) {
              return console.error(err);
            }

            var moves = results[0][0];
            var clicks = results[1][0];

            var patterns = [];

            var firstPos = moves[0];
            var firstClick = clicks[0];

            if (firstClick.time > firstPos.time) {
              moves.splice(0, 1);
              clicks.unshift(firstPos);
            }

            clicks.slice(1).forEach(function(click, index) {
              var hits = _.filter(moves, function(movement) {
                return movement.time < click.time && movement.time > clicks[index].time;
              });

              var rtn = [ clicks[index] ].concat(hits);
              rtn.push(click);

              patterns.push(rtn);
            });

            var path = [];

            patterns.forEach(function(pattern) {
              path = path.concat(caculatePath(pattern));
            });

            callback(path, patterns);
          });
      }

      function execPath(path, callback) {
        (function loop(index) {
          var curr = path[index];

          if (curr) {
            $point.animate({
              left: curr.x - 3.5,
              top: curr.y - 3.5
            }, 4, function() {
              loop(++index);
            })
          } else {
            return callback();
          }
        })(0);
      }

      var mocking = false;
      window.addEventListener('keypress', function(evt) {
        if (mocking) return;

        mocking = true;
        mockPath(function(path, patterns) {
          requestAnimationFrame(function() {
            (function loop(index) {
              var curr = patterns[index];

              if (curr) {
                execPath(path, function() {
                  $point.addClass('click');

                  setTimeout(function() {
                    $point.removeClass('click');
                  }, 1000);

                  loop(++index);
                })
              } else {
                mocking = false;
                min.multi()
                  .set('tracks:move', [])
                  .set('tracks:click', [])
                  .exec(function() {
                    console.log('done');
                  });
              }
            })(0);
          });
        });
        
        return false;
      });
    })();
  </script>
</body>
</html>